<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiger PWL</title>

<!-- PWA Manifest (optional, keep if you already have it) -->
<link rel="manifest" href="manifest.json">

<!-- Service Worker (optional, safe if file is missing) -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js');
  }
</script>

<script>
window.onerror = function(message, source, lineno, colno, error) {
    alert("JS ERROR:\n" + message + "\nLine: " + lineno);
};
</script>

alert("SCRIPT LOADED");

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAB_jJNoouwnRzXBZJz070CqpxZ7JWs3LU",
  authDomain: "tiger-pwl.firebaseapp.com",
  databaseURL: "https://tiger-pwl-default-rtdb.firebaseio.com",
  projectId: "tiger-pwl",
  storageBucket: "tiger-pwl.firebasestorage.app",
  messagingSenderId: "227076305144",
  appId: "1:227076305144:web:a8bd0c185712a0a0a00b0d"
};
firebase.initializeApp(firebaseConfig);
</script>

<style>
body {
  background-color: #111;
  color: white;
  margin: 0;
  font-family: Arial, sans-serif;
}
.screen {
  display: none;
  min-height: 100vh;
  padding: 20px;
  background-color: #a34700;
}
.screen.active {
  display: block;
}

.btn, .home-btn {
  display: block;
  width: 100%;
  padding: 18px;
  margin: 10px 0;
  background: #1e1e1e;
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 20px;
  text-align: center;
}

.small-input {
  width: 48%;
  height: 45px;
  background: #222;
  border: 2px solid #333;
  color: white;
  border-radius: 6px;
  font-size: 16px;
  padding-left: 8px;
  box-sizing: border-box;
}

.fixed-header {
  position: sticky;
  top: 0;
  background: #111;
  padding: 12px;
  text-align: center;
  font-size: 22px;
  font-weight: bold;
  border-bottom: 3px solid #ff8800;
  z-index: 10;
}

.lifter-row {
  border-bottom: 2px solid black;
  padding: 12px 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.row-header {
  font-size: 18px;
  font-weight: bold;
}

.attempt-row {
  display: flex;
  align-items: center;
  gap: 2px;
}

.attempt-input {
  width: 48px;
  height: 42px;
  text-align: center;
  font-size: 15px;
  background: #222;
  border: 2px solid #333;
  color: white;
  border-radius: 6px;
}

.good-lift { background-color: #16A34A !important; }
.failed-lift { background-color: #DC2626 !important; }

.subtotal-box, .total-box {
  margin-left: auto;
  min-width: 60px;
  text-align: right;
  padding: 3px;
  background: white;
  color: #ff8800;
  font-weight: bold;
  border-radius: 8px;
}

.status-btn {
  width: 32px;
  height: 32px;
  background: #444;
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 16px;
}

#popupOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.75);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
#popupBox {
  background: #222;
  padding: 20px;
  width: 80%;
  max-width: 320px;
  border-radius: 12px;
  text-align: center;
}
.popup-btn {
  width: 100%;
  padding: 14px;
  margin: 6px 0;
  border-radius: 10px;
  border: none;
  color: white;
  font-size: 18px;
}
.popup-good { background: #16A34A; }
.popup-fail { background: #DC2626; }
</style>
</head>

<body>

<!-- POPUP -->
<div id="popupOverlay">
  <div id="popupBox">
    <h3>Was this lift good or failed?</h3>
    <button id="btnPopupGood" class="popup-btn popup-good">GOOD</button>
    <button id="btnPopupFail" class="popup-btn popup-fail">FAILED</button>
  </div>
</div>

<!-- HOME -->
<div id="home" class="screen active">
  <h1 style="text-align:center;">Tiger PWL</h1>

  <button id="btnStartNewMeet" class="home-btn">Start New Meet</button>
  <button id="btnLoadOld" class="home-btn">Load Old Meets</button>
  <button id="btnOpenCompetitors" class="home-btn">Competitors</button>
</div>

<!-- MEET SETUP -->
<div id="meetSetup" class="screen">
  <h2>Meet Setup</h2>

  <input id="meetNameInput" class="small-input" style="width:100%;" placeholder="Meet Name">

  <br><br>

  <input id="meetIdInput" class="small-input" style="width:100%;" placeholder="Meet ID (no spaces)">

  <br><br>

  <button id="btnFemaleMeet" class="btn">Female Meet</button>
  <button id="btnMaleMeet" class="btn">Male Meet</button>

  <button id="btnBackFromSetup" class="btn">Back</button>
</div>

<!-- ENTER LIFTERS -->
<div id="enterLifters" class="screen">
  <h2>Enter Lifters</h2>

  <div id="lifterList"></div>

  <button id="btnAddLifter" class="btn">Add Lifter</button>
  <button id="btnCreateMeet" class="btn">Create Meet Sheet</button>
  <button id="btnBackFromLifters" class="btn">Back</button>
</div>

<!-- MEET SHEET -->
<div id="meetSheet" class="screen">
  <div class="fixed-header" id="meetHeader">Tiger PWL</div>

  <div id="meetRows"></div>

  <button id="btnSaveMeet" class="btn">Save Meet</button>
  <button id="btnMeetHome" class="btn">Home</button>
</div>

<!-- COMPETITORS -->
<div id="competitors" class="screen">
  <h2>Competitors</h2>
  <div id="competitorRows"></div>
  <button id="btnCompetitorsBack" class="btn">Back</button>
</div>

<!-- LOAD MEETS -->
<div id="loadMeet" class="screen">
  <h2>Saved Meets</h2>
  <div id="loadList"></div>
  <button id="btnLoadBack" class="btn">Back</button>
</div>

<script>
/* ========= GLOBAL STATE ========= */

let meetName = "";
let meetId = "";
let meetGender = "";

let lifters = [];
let competitorData = [];
let currentAttempt = null;

const FEMALE_CLASSES = ["97","105","114","123","132","148","165","181","198","220","242","242+"];
const MALE_CLASSES   = ["114","123","132","148","165","181","198","220","242","275","308","SHW"];

/* ========= HELPERS ========= */

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ========= MEET SETUP ========= */

function handleSelectGender(gender) {
  meetGender = gender;
  const nameInput = document.getElementById("meetNameInput");
  const idInput   = document.getElementById("meetIdInput");

  meetName = nameInput.value.trim();
  meetId   = idInput.value.trim();

  if (!meetName || !meetId) {
    alert("Enter meet name and meet ID first.");
    return;
  }

  // reset lifters
  lifters = [];
  document.getElementById("lifterList").innerHTML = "";

  activateRealtimeSync();
  showScreen("enterLifters");
}

/* ========= LIFTER ENTRY ========= */

function addLifter() {
  if (lifters.length >= 12) {
    alert("Max 12 lifters.");
    return;
  }

  lifters.push({
    name:"",
    num:"",
    rack:"",
    weightClass:"",
    sq:["","",""],
    be:["","",""],
    dl:["","",""],
    good:{
      sq:[null,null,null],
      be:[null,null,null],
      dl:[null,null,null]
    }
  });
  renderLifterEntry();
}

function renderLifterEntry() {
  const classes = meetGender === "female" ? FEMALE_CLASSES : MALE_CLASSES;
  const list = document.getElementById("lifterList");
  list.innerHTML = "";

  lifters.forEach((L,i)=>{
    list.innerHTML += `
      <div class="lifter-entry-block">
        <input class="small-input" placeholder="Name" value="${L.name}"
          onchange="lifters[${i}].name=this.value">
        <input class="small-input" placeholder="Lifter #" value="${L.num}"
          onchange="lifters[${i}].num=this.value">

        <br><br>

        <input class="small-input" placeholder="Rack" value="${L.rack}"
          onchange="lifters[${i}].rack=this.value">
        <select class="small-input"
          onchange="lifters[${i}].weightClass=this.value">
          <option value="">Weight Class</option>
          ${classes.map(w => `<option value="${w}" ${L.weightClass===w?'selected':''}>${w}</option>`).join("")}
        </select>
      </div>
    `;
  });
}

/* ========= MEET SHEET ========= */

function createMeet() {
  if (lifters.length === 0) {
    alert("Add at least one lifter.");
    return;
  }
  document.getElementById("meetHeader").textContent = meetName;
  renderMeetSheet();
  showScreen("meetSheet");
}

function renderMeetSheet() {
  const rows = document.getElementById("meetRows");
  rows.innerHTML = "";

  lifters.forEach((L,i)=>{
    rows.innerHTML += buildLifterRow(i,L);
    updateTotals(i);
  });
}

function buildLifterRow(i,L) {
  return `
  <div class="lifter-row">
    <div class="row-header">
      ${L.name || "Lifter "+(i+1)}
      ${L.num ? ` (#${L.num})` : ""}
      ${L.rack ? ` - Rack ${L.rack}` : ""}
      ${L.weightClass ? ` - ${L.weightClass}` : ""}
    </div>

    <div class="attempt-row">
      ${attemptInput(i,"sq",0,L)}
      ${attemptInput(i,"sq",1,L)}
      ${attemptInput(i,"sq",2,L)}
    </div>

    <div class="divider-line"></div>

    <div class="attempt-row">
      ${attemptInput(i,"be",0,L)}
      ${attemptInput(i,"be",1,L)}
      ${attemptInput(i,"be",2,L)}
      <div class="subtotal-box" id="sub${i}">0</div>
    </div>

    <div class="divider-line"></div>

    <div class="attempt-row">
      ${attemptInput(i,"dl",0,L)}
      ${attemptInput(i,"dl",1,L)}
      ${attemptInput(i,"dl",2,L)}
      <div class="total-box" id="total${i}">0</div>
    </div>
  </div>`;
}

function attemptInput(i,t,j,L) {
  const val = L[t][j];
  const flag = L.good[t][j];

  const cls = flag===true ? "good-lift" : flag===false ? "failed-lift" : "";
  const icon = flag===true ? "✓" : flag===false ? "X" : "?";

  return `
    <input class="attempt-input ${cls}" value="${val}"
      oninput="attemptEntered(${i},'${t}',${j},this.value)">
    <button class="status-btn" onclick="editLift(${i},'${t}',${j})">${icon}</button>
  `;
}

/* ========= POPUP / LIFTS ========= */

function attemptEntered(i,t,j,value) {
  lifters[i][t][j] = value;
  currentAttempt = {i,t,j};
  openPopup();
}
function editLift(i,t,j) {
  currentAttempt = {i,t,j};
  openPopup();
}
function openPopup() {
  document.getElementById("popupOverlay").style.display = "flex";
}
function closePopup() {
  document.getElementById("popupOverlay").style.display = "none";
}
function confirmGood() { setLift(true); }
function confirmFail() { setLift(false); }

function setLift(flag) {
  const {i,t,j} = currentAttempt;
  if (!lifters[i]) return;
  lifters[i].good[t][j] = flag;
  updateTotals(i);
  saveMeet();
  renderMeetSheet();
  closePopup();
}

/* ========= TOTALS ========= */

function updateTotals(i) {
  const L = lifters[i];

  function best(vals,flags) {
    return Math.max(...vals.map((v,idx)=> flags[idx]===true ? Number(v)||0 : 0));
  }

  const sq = best(L.sq,L.good.sq);
  const be = best(L.be,L.good.be);
  const dl = best(L.dl,L.good.dl);

  const subtotal = sq + be;
  const total    = subtotal + dl;

  const subEl   = document.getElementById(`sub${i}`);
  const totalEl = document.getElementById(`total${i}`);
  if (subEl) subEl.textContent = subtotal;
  if (totalEl) totalEl.textContent = total;
}

/* ========= FIREBASE SAVE / LOAD / SYNC ========= */

function saveMeet() {
  if (!meetId) return;
  firebase.database().ref(`meets/${meetId}`).set({
    meetName,
    meetGender,
    lifters
  });
}

function loadMeetList() {
  const list = document.getElementById("loadList");
  list.innerHTML = "";

  firebase.database().ref("meets").once("value", snap=>{
    snap.forEach(child=>{
      const key = child.key;
      const data = child.val();
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = `${data.meetName} (${key})`;
      btn.addEventListener("click", ()=> loadMeet(key));
      list.appendChild(btn);
    });
  });

  showScreen("loadMeet");
}

function loadMeet(key) {
  meetId = key;
  firebase.database().ref(`meets/${key}`).once("value", snap=>{
    const d = snap.val();
    if (!d) return;
    meetName = d.meetName;
    meetGender = d.meetGender;
    lifters = d.lifters || [];
    document.getElementById("meetHeader").textContent = meetName;
    activateRealtimeSync();
    renderMeetSheet();
    showScreen("meetSheet");
  });
}

function activateRealtimeSync() {
  if (!meetId) return;
  firebase.database().ref(`meets/${meetId}`).off(); // clear old
  firebase.database().ref(`meets/${meetId}`).on("value", snap=>{
    const d = snap.val();
    if (!d) return;
    meetName   = d.meetName;
    meetGender = d.meetGender;
    lifters    = d.lifters || [];
    if (document.getElementById("meetSheet").classList.contains("active")) {
      renderMeetSheet();
    }
  });
}

/* ========= COMPETITORS (LOCAL ONLY) ========= */

function openCompetitors() {
  competitorData = Array.from({length:12}, ()=>({
    sq:["","",""], be:["","",""], dl:["","",""],
    good:{sq:[null,null,null],be:[null,null,null],dl:[null,null,null]}
  }));
  renderCompetitors();
  showScreen("competitors");
}

function renderCompetitors() {
  const rows = document.getElementById("competitorRows");
  rows.innerHTML = "";

  competitorData.forEach((L,i)=>{
    rows.innerHTML += `
      <div class="lifter-row">
        <div class="row-header">Competitor ${i+1}</div>
        <div class="attempt-row">
          ${compInput(i,"sq",0,L)}
          ${compInput(i,"sq",1,L)}
          ${compInput(i,"sq",2,L)}
        </div>
        <div class="divider-line"></div>
        <div class="attempt-row">
          ${compInput(i,"be",0,L)}
          ${compInput(i,"be",1,L)}
          ${compInput(i,"be",2,L)}
          <div class="subtotal-box" id="csub${i}">0</div>
        </div>
        <div class="divider-line"></div>
        <div class="attempt-row">
          ${compInput(i,"dl",0,L)}
          ${compInput(i,"dl",1,L)}
          ${compInput(i,"dl",2,L)}
          <div class="total-box" id="ctotal${i}">0</div>
        </div>
      </div>
    `;
    updateCompetitorTotals(i);
  });
}

function compInput(i,t,j,L) {
  const val = L[t][j];
  const flag = L.good[t][j];
  const cls = flag===true ? "good-lift" : flag===false ? "failed-lift" : "";
  const icon = flag===true ? "✓" : flag===false ? "X" : "?";

  return `
    <input class="attempt-input ${cls}" value="${val}"
      oninput="competitorValue(${i},'${t}',${j},this.value)">
    <button class="status-btn" onclick="competitorFlag(${i},'${t}',${j})">${icon}</button>
  `;
}

function updateCompetitorTotals(i) {
  const L = competitorData[i];

  function best(vals,flags){
    return Math.max(...vals.map((v,idx)=> flags[idx]===true ? Number(v)||0 : 0));
  }

  const sq = best(L.sq,L.good.sq);
  const be = best(L.be,L.good.be);
  const dl = best(L.dl,L.good.dl);

  const subEl   = document.getElementById(`csub${i}`);
  const totalEl = document.getElementById(`ctotal${i}`);

  if (subEl) subEl.textContent = sq+be;
  if (totalEl) totalEl.textContent = sq+be+dl;
}

function competitorValue(i,t,j,v) {
  competitorData[i][t][j] = v;
  currentAttempt = {competitor:true,i,t,j};
  openPopup();
}

function competitorFlag(i,t,j) {
  currentAttempt = {competitor:true,i,t,j};
  openPopup();
}

/* ========= INIT & EVENT BINDING ========= */

function init() {

  console.log("INIT RUNNING — JS is active.");

  /* ----------------------------------------------------------
     GUARANTEED BUTTON HOOKS FOR FEMALE/MALE MEET
     (Uses text matching so hosting cannot break IDs)
  ---------------------------------------------------------- */
  document.querySelectorAll("button").forEach(btn => {
    let txt = btn.textContent.trim();

    if (txt === "Female Meet") {
      console.log("Female Meet button FOUND");
      btn.addEventListener("click", () => handleSelectGender("female"));
    }

    if (txt === "Male Meet") {
      console.log("Male Meet button FOUND");
      btn.addEventListener("click", () => handleSelectGender("male"));
    }
  });


  /* ----------------------------------------------------------
     HOME BUTTONS
  ---------------------------------------------------------- */
  document.getElementById("btnStartNewMeet").addEventListener("click", () => showScreen("meetSetup"));
  document.getElementById("btnLoadOld").addEventListener("click", loadMeetList);
  document.getElementById("btnOpenCompetitors").addEventListener("click", openCompetitors);


  /* ----------------------------------------------------------
     LIFTER ENTRY BUTTONS
  ---------------------------------------------------------- */
  document.getElementById("btnAddLifter").addEventListener("click", addLifter);
  document.getElementById("btnCreateMeet").addEventListener("click", createMeet);
  document.getElementById("btnBackFromLifters").addEventListener("click", () => showScreen("home"));


  /* ----------------------------------------------------------
     MEET SHEET BUTTONS
  ---------------------------------------------------------- */
  document.getElementById("btnSaveMeet").addEventListener("click", saveMeet);
  document.getElementById("btnMeetHome").addEventListener("click", () => showScreen("home"));


  /* ----------------------------------------------------------
     LOAD MEETS
  ---------------------------------------------------------- */
  document.getElementById("btnLoadBack").addEventListener("click", () => showScreen("home"));


  /* ----------------------------------------------------------
     COMPETITORS
  ---------------------------------------------------------- */
  document.getElementById("btnCompetitorsBack").addEventListener("click", () => showScreen("home"));


  /* ----------------------------------------------------------
     POPUP BUTTONS
  ---------------------------------------------------------- */
  document.getElementById("btnPopupGood").addEventListener("click", confirmGood);
  document.getElementById("btnPopupFail").addEventListener("click", confirmFail);


  /* ----------------------------------------------------------
     EXPOSE LIFT FUNCTIONS FOR DYNAMIC ATTEMPTS
  ---------------------------------------------------------- */
  window.attemptEntered   = attemptEntered;
  window.editLift         = editLift;
  window.competitorValue  = competitorValue;
  window.competitorFlag   = competitorFlag;
  window.confirmGood      = confirmGood;
  window.confirmFail      = confirmFail;

  console.log("INIT COMPLETE — all listeners attached.");
}

window.addEventListener("load", init);
</script>

</body>
</html>
